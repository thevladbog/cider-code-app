# –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ Yandex Cloud Logging

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–û—à–∏–±–∫–∞ –≤–∏–¥–∞:

```
ClientError: /yandex.cloud.logging.v1.LogIngestionService/Write UNAUTHENTICATED:
request-id = xxx rpc error: code = Unauthenticated desc = The token has expired
2025-06-16T05:55:04.752284226Z. Now 2025-06-16T16:35:04.598685221Z, which is more than PT10M later
```

–í–æ–∑–Ω–∏–∫–∞–µ—Ç –∫–æ–≥–¥–∞ IAM —Ç–æ–∫–µ–Ω –¥–ª—è Yandex Cloud –∏—Å—Ç–µ–∫–∞–µ—Ç.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Service Account Key

### 1. –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

```bash
npm run diagnose:logging
```

–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –ø–æ–∫–∞–∂–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ –≤—ã–≤–µ–¥–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.

### 2. –ü–æ—à–∞–≥–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ Service Account

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Yandex Cloud Console](https://console.cloud.yandex.ru)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **IAM** ‚Üí **–°–µ—Ä–≤–∏—Å–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã**
3. –ù–∞–∂–º–∏—Ç–µ **–°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç**
4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - **–ù–∞–∑–≤–∞–Ω–∏–µ**: `bottle-code-app-logging`
   - **–û–ø–∏—Å–∞–Ω–∏–µ**: `Service account for Bottle Code App logging`

#### –®–∞–≥ 2: –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π

–ù–∞–∑–Ω–∞—á—å—Ç–µ —Å–µ—Ä–≤–∏—Å–Ω–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É —Ä–æ–ª–∏:

- `logging.writer` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ - –¥–ª—è –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤)
- `logging.reader` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –¥–ª—è —á—Ç–µ–Ω–∏—è –ª–æ–≥–æ–≤)

#### –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ä—Ç–æ—á–∫—É —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
2. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É **–ö–ª—é—á–∏**
3. –ù–∞–∂–º–∏—Ç–µ **–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á** ‚Üí **–°–æ–∑–¥–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á**
4. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç **JSON**
5. –°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª —Å –∫–ª—é—á–æ–º

#### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ/–æ–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
# –í–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
YANDEX_CLOUD_LOGGING_ENABLED=true

# Service Account Key (–∑–∞–º–µ–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º—ã–º —Å–∫–∞—á–∞–Ω–Ω–æ–≥–æ JSON —Ñ–∞–π–ª–∞)
YANDEX_SERVICE_ACCOUNT_KEY={"id":"...","service_account_id":"...","private_key":"-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"}

# ID –ø–∞–ø–∫–∏ (–Ω–∞–π–¥–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ Yandex Cloud)
YANDEX_FOLDER_ID=–≤–∞—à-folder-id

# ID –ª–æ–≥-–≥—Ä—É–ø–ø—ã (—Å–æ–∑–¥–∞–π—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª–µ Cloud Logging)
YANDEX_LOG_GROUP_ID=–≤–∞—à-log-group-id

# –£–¥–∞–ª–∏—Ç–µ —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å:
# YANDEX_IAM_TOKEN=...
# YANDEX_OAUTH_TOKEN=...
```

#### –®–∞–≥ 5: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
npm run start
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:

```bash
npm run test:environment:unified
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:

- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Service Account Key (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- ‚úÖ –õ–æ–≥–≥–µ—Ä —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –û–±–ª–∞—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üîß –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:

1. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
2. **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏**: –î–æ 3 –ø–æ–ø—ã—Ç–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
3. **Graceful degradation**: –ü—Ä–∏ –Ω–µ—É–¥–∞—á–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
4. **Cooldown –ø–µ—Ä–∏–æ–¥**: 5 –º–∏–Ω—É—Ç –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π –æ–±–ª–∞—á–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**: –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç –æ–±–ª–∞—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
npm run setup:yandex-logging

# –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
npm run diagnose:logging

# –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
npm run test:environment:unified
```

## üÜò –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: JSON –∫–ª—é—á –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å JSON
node -e "console.log(JSON.parse(process.env.YANDEX_SERVICE_ACCOUNT_KEY))"
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–µ—Ä–≤–∏—Å–Ω–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ä–æ–ª—å `logging.writer` –¥–ª—è –Ω—É–∂–Ω–æ–π –ø–∞–ø–∫–∏ –∏–ª–∏ –ª–æ–≥-–≥—Ä—É–ø–ø—ã.

### –ü—Ä–æ–±–ª–µ–º–∞: –õ–æ–≥-–≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

1. –°–æ–∑–¥–∞–π—Ç–µ –ª–æ–≥-–≥—Ä—É–ø–ø—É –≤ —Ä–∞–∑–¥–µ–ª–µ **Cloud Logging**
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ—ë ID –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `YANDEX_LOG_GROUP_ID`

### –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –æ–±–ª–∞—á–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

–ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏–ª–∞ –æ–±–ª–∞—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```javascript
// –í –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
logger.forceEnableCloudLogging();
```

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Service Account Key

- ‚úÖ **–ù–µ –∏—Å—Ç–µ–∫–∞–µ—Ç** –∫–∞–∫ IAM —Ç–æ–∫–µ–Ω—ã
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è** SDK
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ** –¥–ª—è production –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ **–ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç —Å rotation** –∫–ª—é—á–µ–π

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å IAM —Ç–æ–∫–µ–Ω–æ–≤

1. –°–æ–∑–¥–∞–π—Ç–µ Service Account Key (—Å–º. –≤—ã—à–µ)
2. –û–±–Ω–æ–≤–∏—Ç–µ `.env` —Ñ–∞–π–ª
3. –£–¥–∞–ª–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `YANDEX_IAM_TOKEN`
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
